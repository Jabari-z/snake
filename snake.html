<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>è´ªåƒè›‡</title>
</head>
<body>
    <center>
    <h1>è´ªåƒè›‡</h1>
    <div id="score">0</div>
    <div><button type="submit" id="btn_submit"> å¼€å§‹æ¸¸æˆ </button></div>
    <br>
    <canvas id="gameCanvas" width="300" height="300"></canvas>
    <p>ç‚¹å‡»å¼€å§‹æ¸¸æˆ <br> ä¸Šä¸‹å·¦å³é”®æ§åˆ¶ğŸçš„æ–¹å‘</p>
    <style>  
        #score {
            font-size:100px; 
            font-family: 'Antic Slab', serif
        }        
    </style>
    <script>
        // å¸¸é‡
        const CANVAS_BORDER_COLOUR = 'black';            
        const CANVAS_BACKGROUND_COLOUR = "white";            
        // è·å– canvas å…ƒç´ 
        var gameCanvas = document.getElementById("gameCanvas");            
        // è¿”å›ä¸€ä¸ªäºŒç»´ç»˜å›¾ä¸Šä¸‹æ–‡ 
        var ctx = gameCanvas.getContext("2d");            
        // é€‰æ‹©ç”»å¸ƒçš„èƒŒæ™¯é¢œè‰²
        ctx.fillStyle = CANVAS_BACKGROUND_COLOUR;            
        // é€‰æ‹©ç”»å¸ƒçš„è¾¹æ¡†é¢œè‰²
        ctx.strokestyle = CANVAS_BORDER_COLOUR;            
        // ç»˜åˆ¶ä¸€ä¸ªâ€œå®å¿ƒçš„â€é•¿æ–¹å½¢æ¥è¦†ç›–æ•´ä¸ªç”»å¸ƒ
        ctx.fillRect(0, 0, gameCanvas.width, gameCanvas.height);           
        // ç»˜åˆ¶ç”»å¸ƒçš„â€œè¾¹æ¡†â€
        ctx.strokeRect(0, 0, gameCanvas.width, gameCanvas.height);

        //æ³¨æ„è›‡æ‰€æœ‰éƒ¨ä½çš„ y åæ ‡éƒ½æ˜¯ 150ã€‚
        //æ¯ä¸€éƒ¨ä½çš„ x åæ ‡æ¯”ï¼ˆå·¦è¾¹ï¼‰å‰ä¸€ä¸ªéƒ¨ä½å¤š 10 px -> ç§»é€Ÿ å¦åˆ™ è„±èŠ‚äº†
        //æ•°ç»„ä¸­çš„ç¬¬ä¸€å¯¹åæ ‡ {x: 150, y: 150} è¡¨ç¤ºè›‡å¤´ï¼Œ
        let snake =[
            {x : 150, y : 150},  // å¤´
            {x : 140, y : 150},
            {x : 130, y : 150},
            {x : 120, y : 150},
            {x : 110, y : 150},
        ];
        // changingDirection ä¸º true æ—¶è¡¨ç¤ºè›‡æ­£åœ¨æ”¹å˜æ–¹å‘
        let changingDirection = false;  
        // æ¨ªçºµå‘ç§»åŠ¨é€Ÿåº¦
        let dx = 10;
        let dy = 0;
        // é£Ÿç‰©åæ ‡
        let foodX;
        let foodY;
        //ç©å®¶åˆ†æ•°
        let score = 0;
        // createFood();
        // main();
        // document.addEventListener("keydown", changeDirection);
        // æ¸¸æˆå¼€å§‹æŒ‰é’®äº‹ä»¶ç»‘å®š
        document.getElementById("btn_submit").onclick=start;
       

        //åœ¨ç”»å¸ƒä¸Šç”»è›‡çš„ä¸€ä¸ªéƒ¨åˆ†
        function drawSnakePart(snakePart){
            ctx.fillStyle = 'lightgreen';
            ctx.strokeStyle = 'darkgreen';
            ctx.fillRect(snakePart.x,snakePart.y,10,10);
            ctx.strokeRect(snakePart.x,snakePart.y,10,10);
        }

        //ç”»è›‡
        function drawSnake(){
            // snakeçš„æ¯ä¸€éƒ¨åˆ†é€šè¿‡foreach draw
            snake.forEach(drawSnakePart);
        }

        
        //æ ¹æ®è›‡çš„æ°´å¹³ç§»åŠ¨é€Ÿåº¦æ”¹å˜è›‡çš„ x åæ ‡ï¼Œ
        //æ ¹æ®è›‡çš„å‚ç›´ç§»åŠ¨é€Ÿåº¦æ”¹å˜è›‡çš„ y åæ ‡
        function advanceSnake(){
            const head = {
                x:snake[0].x+dx,
                y:snake[0].y+dy
            };
            snake.unshift(head); //åŠ ä¸€ä¸ª
            //æ˜¯å¦åƒäº†é£Ÿç‰©
            const didEatFood = snake[0].x===foodX && snake[0].y===foodY;
            if(didEatFood){
                score += 10;
                console.log(score);
                document.getElementById('score').innerHTML = score;
                createFood()
            }else{
                snake.pop(); //å‡ä¸€ä¸ª
            }
      }

        //æ¸…ç©ºå±å¹•
        function clearCanvas(){
            ctx.fillStyle = "white";
            ctx.strokeStyle = "black";
            ctx.fillRect(0,0,gameCanvas.width,gameCanvas.height);
            ctx.strokeRect(0,0,gameCanvas.width,gameCanvas.height);
        }

        function main() {
            if (didGameEnd()) {
                console.log("æ¸¸æˆç»“æŸ");
                alert("GAME OVER"); 
                return;
            }
            setTimeout(function onTick() {
                //åªæœ‰åœ¨æ”¹å˜æ–¹å‘ä¸ºfalse
                changingDirection = false;
                clearCanvas();
                drawFood();
                advanceSnake();
                drawSnake();  
                // å†æ¬¡è°ƒç”¨ main å‡½æ•° å¥—å¨ƒ
                main();
            }, 100)
        }

        //æŒ‰é”®äº‹ä»¶ æ”¹å˜æ–¹å‘
        function changeDirection(event){
            const LEFT_KEY = 37;
            const RIGHT_KEY = 39;
            const UP_KEY = 38;
            const DOWN_KEY = 40;

            // å¦‚æœæ­£åœ¨æ”¹å˜æ–¹å‘ è¿”å›
            if (changingDirection) return;
            // å‡†å¤‡æ”¹å˜æ–¹å‘
            changingDirection = true;
            const keyPressed = event.keyCode;
            const goingUp = dy === -10;
            const goingDown = dy === 10;
            const goingRight = dx === 10;
            const goingLeft = dx === -10;    
            if (keyPressed === LEFT_KEY && !goingRight) {        
                dx = -10;        
                dy = 0;
            }  
            if (keyPressed === UP_KEY && !goingDown) {        
                dx = 0;        
                dy = -10;
            }  
            if (keyPressed === RIGHT_KEY && !goingLeft) {        
                dx = 10;        
                dy = 0;
            }  
            if (keyPressed === DOWN_KEY && !goingUp) {        
                dx = 0;        
                dy = 10;
            }

        }

        // éšæœºæ•°
        function randomTen(min,max){
            return Math.round((Math.random() * (max-min) + min) / 10) * 10;
        }
        function createFood(){
            // éšæœºä½ç½®
            foodX = randomTen(0,gameCanvas.width-10);
            foodY = randomTen(0,gameCanvas.height-10);
            // ä¸èƒ½ä¸ğŸèº«ä½“é‡åˆ
            snake.forEach(function isFoodOnSnake(part){
                const foodIsOnSnake = part.x == foodX && part.y == foodY;
                if (foodIsOnSnake) createFood();
            });
        }
        function drawFood(){
            ctx.fillStyle = 'red';
            ctx.strokestyle = 'darkred';
            ctx.fillRect(foodX, foodY, 10, 10);
            ctx.strokeRect(foodX, foodY, 10, 10);
            
        }
        // æ¸¸æˆç»“æŸåˆ¤å®š
        function didGameEnd(){
            // å¤´æ’åˆ°èº«ä½“
            for (let i = 4; i < snake.length; i++) {          
                const didCollide = snake[i].x === snake[0].x && snake[i].y === snake[0].y;
                if (didCollide) return true;
            }
            // ç¢°åˆ°è¾¹ç¼˜
            const hitLeftWall = snake[0].x < 0;    
            const hitRightWall = snake[0].x > gameCanvas.width - 10;    
            const hitToptWall = snake[0].y < 0;    
            const hitBottomWall = snake[0].y > gameCanvas.height - 10;   
            
            return hitLeftWall || hitRightWall || hitToptWall ||hitBottomWall;
        }

        function start(){
            console.log("æ¸¸æˆå¼€å§‹  ->  ");
            createFood();
            main();
            document.addEventListener("keydown", changeDirection);
        }

    </script>
    </center>

</body>
</html>